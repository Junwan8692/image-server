<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <title>ì”¬ ì´ë¯¸ì§€ ë¹„êµ GUI</title>
  <style>
    body {
      background-color: #0d0d0d;
      color: #fff;
      font-family: "Pretendard", "Noto Sans KR", sans-serif;
      text-align: center;
      margin: 0;
      user-select: none;
      -webkit-user-drag: none;

      /* â–¼ [ìˆ˜ì •] ìƒë‹¨/í•˜ë‹¨ ê³ ì • UIë¥¼ ìœ„í•œ body íŒ¨ë”© ì¶”ê°€ */
      padding-top: 150px;
      /* ê³ ì •ëœ í—¤ë”ì˜ ë†’ì´ë§Œí¼ ì—¬ë°± */
      padding-bottom: 90px;
      /* ê³ ì •ëœ ì»¨íŠ¸ë¡¤ì˜ ë†’ì´ë§Œí¼ ì—¬ë°± */
    }

    /* â–¼ [ì¶”ê°€] ìƒë‹¨ ê³ ì • í—¤ë” ì»¨í…Œì´ë„ˆ */
    .header-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background-color: #0d0d0d;
      z-index: 100;
      padding: 20px 30px 15px 30px;
      box-sizing: border-box;
      /* íŒ¨ë”©ì´ ë„ˆë¹„ì— í¬í•¨ë˜ë„ë¡ ì„¤ì • */
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.7);
    }

    /* â–¼ [ìˆ˜ì •] í•˜ë‹¨ ê³ ì • ì»¨íŠ¸ë¡¤ */
    .controls {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #0d0d0d;
      z-index: 100;
      padding: 20px 30px;
      box-sizing: border-box;
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.7);
    }

    h2 {
      font-size: 26px;
      margin-top: 0;
      /* â–¼ [ìˆ˜ì •] í—¤ë” ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ì—¬ë°± ì¡°ì • */
      margin-bottom: 10px;
    }

    p {
      font-size: 16px;
      color: #bbb;
      margin-top: 0;
      /* â–¼ [ìˆ˜ì •] í—¤ë” ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ì—¬ë°± ì¡°ì • */
      margin-bottom: 15px;
    }

    #zoomControls {
      margin-bottom: 0;
      /* â–¼ [ìˆ˜ì •] í—¤ë” ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ì—¬ë°± ì¡°ì • */
    }

    /* â–¼ [ì¶”ê°€] ë©”ì¸ ì½˜í…ì¸  (ìŠ¤í¬ë¡¤ ì˜ì—­) */
    .main-content {
      padding: 0 30px;
      /* ì¢Œìš° ì—¬ë°± */
    }

    .scene-section {
      display: flex;
      flex-direction: row;
      justify-content: center;
      gap: 20px;
      overflow-x: auto;
      border-top: 1px solid #333;
      padding-top: 20px;
    }

    .cut-block {
      display: inline-block;
      text-align: center;
      margin: 0 auto;
    }

    .cut-title {
      color: #f7d794;
      font-size: 18px;
      margin-bottom: 8px;
    }

    .merged-container {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0;
      line-height: 0;
      margin: 0 auto;
      padding: 0;
      width: 400px;
      transform-origin: top center;
      transition: transform 0.15s linear;
    }

    .merged-img {
      display: block;
      width: 100%;
    }

    .guide-canvas {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      z-index: 5;
      cursor: crosshair;
    }

    button {
      background-color: #333;
      color: white;
      padding: 10px 18px;
      margin: 0 5px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: 0.2s;
    }

    button:hover {
      background-color: #555;
    }

    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    #saveBtn.active {
      background-color: #007bff;
    }
  </style>
</head>

<body>
  <div class="header-container">
    <h2 id="sceneTitle">ì”¬ ë¡œë”© ì¤‘...</h2>
    <p id="narrationText"></p>

    <div id="zoomControls">
      <button id="zoomOut">- ì¶•ì†Œ</button>
      <button id="zoomIn">+ í™•ëŒ€</button>
      <span id="zoomLevel" style="margin-left:10px; color:#bbb;">100%</span>
    </div>
  </div>

  <div class="main-content">
    <div id="cutsContainer"></div>
  </div>

  <div class="controls">
    <button id="prevBtn">ì´ì „</button>
    <button id="nextBtn">ë‹¤ìŒ</button>
    <button id="saveBtn" disabled>ì €ì¥í•˜ê¸°</button>
  </div>

  <script>
    const rawJobData = {{ job | tojson }};
    const jobData = Array.isArray(rawJobData) ? rawJobData[0] : rawJobData;

    // ğŸ‘ˆ [ì¶”ê°€] í˜„ì¬ ì‘ì—…ì˜ job_idë¥¼ JS ë³€ìˆ˜ë¡œ ì €ì¥
    const JOB_ID = {{ job_id | tojson }};

    const scenes = jobData.scenes || [];
    const allImages = jobData.all_images || [];
    const imageMap = Object.fromEntries(allImages.map(i => [i.name, i.url]));
    let currentIndex = 0, zoomScale = 1.0;
    const guides = {};

    const sceneTitle = document.getElementById("sceneTitle");
    const narrationText = document.getElementById("narrationText");
    const cutsContainer = document.getElementById("cutsContainer");
    const saveBtn = document.getElementById("saveBtn");

    // ğŸ”¹ ì¤Œ ì»¨íŠ¸ë¡¤
    document.getElementById("zoomIn").onclick = () => { zoomScale = Math.min(zoomScale + 0.1, 2.0); updateZoom(); };
    document.getElementById("zoomOut").onclick = () => { zoomScale = Math.max(zoomScale - 0.1, 0.5); updateZoom(); };
    function updateZoom() {
      document.querySelectorAll(".merged-container").forEach(c => c.style.transform = `scale(${zoomScale})`);
      document.getElementById("zoomLevel").innerText = `${Math.round(zoomScale * 100)}%`;
    }

    function proxyUrl(url) { return `/image_proxy?url=${encodeURIComponent(url)}`; }

    function getAdjacentImages(name) {
      if (!name) return []; // ğŸ‘ˆ [ì¶”ê°€] nameì´ nullì¼ ê²½ìš° ë°©ì–´ ì½”ë“œ
      const match = name.match(/(\d+)\.jpg$/);
      if (!match) return [];
      const base = parseInt(match[1], 10);
      const prev = name.replace(match[1], String(base - 1).padStart(match[1].length, "0"));
      const next = name.replace(match[1], String(base + 1).padStart(match[1].length, "0"));
      return [prev, next];
    }

    function renderMergedImage(name, type, sceneNum) {
      if (!name || !imageMap[name]) return "";
      const [prev, next] = getAdjacentImages(name);
      const imgs = [prev, name, next]
        .filter(n => imageMap[n]) // ğŸ‘ˆ [ìˆ˜ì •] imageMap[n]ì´ ìˆëŠ”ì§€ í™•ì¸
        .map(n => `<img class="merged-img" src="${proxyUrl(imageMap[n])}" alt="${n}">`)
        .join("");
      return `
        <div class="merged-container" data-scene="${sceneNum}" data-type="${type}">
          ${imgs}
          <canvas class="guide-canvas"></canvas>
        </div>`;
    }

    // ğŸ”¹ ê°€ì´ë“œ ë¡œì§
    function setupGuideCanvas() {
      document.querySelectorAll(".merged-container").forEach(container => {
        const imgs = container.querySelectorAll("img");
        if (imgs.length === 0) return; // ğŸ‘ˆ [ì¶”ê°€] ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ ìº”ë²„ìŠ¤ ì„¤ì • ì•ˆí•¨

        const canvas = container.querySelector(".guide-canvas");
        const ctx = canvas.getContext("2d");

        Promise.all(Array.from(imgs).map(img => new Promise(res => img.complete ? res() : img.onload = res)))
          .then(() => {
            // ğŸ‘ˆ [ì¶”ê°€] ì²« ë²ˆì§¸ ì´ë¯¸ì§€ê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (!imgs[0] || !imgs[0].clientWidth || !imgs[0].clientHeight) {
              console.warn(`ì´ë¯¸ì§€ í¬ê¸° 0, ìº”ë²„ìŠ¤ ì„¤ì • ê±´ë„ˆëœ€: ${container.dataset.scene}_${container.dataset.type}`);
              return;
            }
            const totalHeight = Array.from(imgs).reduce((sum, img) => sum + img.clientHeight, 0);
            const width = imgs[0].clientWidth;
            canvas.width = width;
            canvas.height = totalHeight;

            let startX, startY, isDrawing = false, currentWidth = 0, currentHeight = 0;
            const key = `${container.dataset.scene}_${container.dataset.type}`;

            // âœ… ê¸°ë³¸ ìš°í´ë¦­ ë©”ë‰´ ë¹„í™œì„±í™”
            canvas.oncontextmenu = e => e.preventDefault();

            // âœ… ë§ˆìš°ìŠ¤ ë‹¤ìš´
            canvas.onmousedown = e => {
              if (e.button === 2) { // ğŸ‘‰ ì˜¤ë¥¸ìª½ í´ë¦­: ê°€ì´ë“œ ì‚­ì œ
                delete guides[key];
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                console.log("ğŸ—‘ï¸ ê°€ì´ë“œ ì‚­ì œ:", key);
                saveBtn.disabled = Object.keys(guides).length === 0; // ğŸ‘ˆ [ìˆ˜ì •] ê°€ì´ë“œê°€ 0ê°œë©´ ì €ì¥ ë¹„í™œì„±í™”
                return;
              }

              const rect = canvas.getBoundingClientRect();
              startX = e.clientX - rect.left;
              startY = e.clientY - rect.top;
              isDrawing = true;
            };

            // âœ… ë§ˆìš°ìŠ¤ ì´ë™ ì¤‘ ê°€ì´ë“œ í‘œì‹œ
            canvas.onmousemove = e => {
              if (!isDrawing) return;
              const rect = canvas.getBoundingClientRect();
              const x = e.clientX - rect.left;
              const y = e.clientY - rect.top;
              const dx = x - startX, dy = y - startY;
              const targetRatio = 9 / 16;
              let width = dx, height = dy;

              if (Math.abs(dx / dy) > targetRatio)
                width = Math.sign(dx) * Math.abs(dy) * targetRatio;
              else
                height = Math.sign(dy) * Math.abs(dx) / targetRatio;

              currentWidth = width; currentHeight = height;

              ctx.clearRect(0, 0, canvas.width, canvas.height);
              ctx.fillStyle = "rgba(0, 255, 0, 0.25)";
              ctx.fillRect(startX, startY, width, height);
              ctx.strokeStyle = "rgba(0,255,0,0.9)";
              ctx.lineWidth = 2;
              ctx.strokeRect(startX, startY, width, height);
            };

            // âœ… ë§ˆìš°ìŠ¤ ì—… â†’ ê°€ì´ë“œ í™•ì •
            canvas.onmouseup = e => {
              if (!isDrawing || e.button === 2) return;
              isDrawing = false;

              // ğŸ‘ˆ [ì¶”ê°€] ë„ˆë¹„ë‚˜ ë†’ì´ê°€ ë„ˆë¬´ ì‘ìœ¼ë©´ ë¬´ì‹œ
              if (Math.abs(currentWidth) < 10 || Math.abs(currentHeight) < 10) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                console.log("â„¹ï¸ ê°€ì´ë“œê°€ ë„ˆë¬´ ì‘ì•„ ì €ì¥í•˜ì§€ ì•ŠìŒ");
                return;
              }

              const rect = canvas.getBoundingClientRect();
              const crop = {
                x: Math.min(startX, startX + currentWidth),
                y: Math.min(startY, startY + currentHeight),
                w: Math.abs(currentWidth),
                h: Math.abs(currentHeight),
                display_w: canvas.width,
                display_h: canvas.height
              };

              guides[key] = crop;
              console.log("ğŸ¯ ê°€ì´ë“œ ì €ì¥:", key, crop);

              // ğŸ‘ˆ [ìˆ˜ì •] ê°€ì´ë“œê°€ 1ê°œë¼ë„ ìˆìœ¼ë©´ ì €ì¥ ë²„íŠ¼ í™œì„±í™”
              saveBtn.disabled = false;

              ctx.clearRect(0, 0, canvas.width, canvas.height);
              ctx.fillStyle = "rgba(0, 255, 0, 0.2)";
              ctx.fillRect(crop.x, crop.y, crop.w, crop.h);
              ctx.strokeStyle = "rgba(0,255,0,0.9)";
              ctx.lineWidth = 2;
              ctx.strokeRect(crop.x, crop.y, crop.w, crop.h);
            };

            // âœ… ê¸°ì¡´ ê°€ì´ë“œ ë³µì›
            if (guides[key]) {
              const g = guides[key];
              ctx.fillStyle = "rgba(0, 255, 0, 0.2)";
              ctx.fillRect(g.x, g.y, g.w, g.h);
              ctx.strokeStyle = "rgba(0,255,0,0.9)";
              ctx.lineWidth = 2;
              ctx.strokeRect(g.x, g.y, g.w, g.h);
            }
          });
      });
    }


    // ğŸ”¹ ì”¬ ë Œë”ë§
    function renderScene() {
      // ğŸ‘ˆ [ìˆ˜ì •] ê°€ì´ë“œê°€ 1ê°œë¼ë„ ìˆìœ¼ë©´ ì €ì¥ ë²„íŠ¼ í™œì„±í™” (ì”¬ ì´ë™ ì‹œ ì²´í¬)
      saveBtn.disabled = Object.keys(guides).length === 0;
      saveBtn.classList.remove("active"); // ë¯¸ë¦¬ë³´ê¸° ë‹¨ê³„ ì•„ë‹ˆë©´ active í´ë˜ìŠ¤ ì œê±°

      if (currentIndex === scenes.length) {
        sceneTitle.innerText = "ğŸ–¼ï¸ ë¯¸ë¦¬ë³´ê¸° (ìµœì¢… ì €ì¥ ì „ í™•ì¸)";
        narrationText.innerText = "ì•„ë˜ëŠ” ì„ íƒí•œ ì»·ë“¤ì˜ crop ê²°ê³¼ì…ë‹ˆë‹¤. (ê°€ì´ë“œê°€ ì—†ëŠ” ì”¬ì€ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)";
        cutsContainer.innerHTML = "";

        // ğŸ‘ˆ [ìˆ˜ì •] ê°€ì´ë“œê°€ 0ê°œë©´ ì €ì¥ ë²„íŠ¼ ë¹„í™œì„±í™”, 1ê°œ ì´ìƒì´ë©´ í™œì„±í™”
        saveBtn.disabled = Object.keys(guides).length === 0;
        if (!saveBtn.disabled) {
          saveBtn.classList.add("active");
        }

        // ğŸ‘ˆ [ìˆ˜ì •] fetch payloadì— job_id ì¶”ê°€
        const payload = {
          job_id: JOB_ID,
          guides: guides
        };

        fetch("/preview_crops", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload) // ğŸ‘ˆ [ìˆ˜ì •]
        })
          .then(r => r.json())
          .then(res => {
            // ğŸ‘ˆ [ìˆ˜ì •] ì„œë²„ ì‘ë‹µ í˜•ì‹ ë³€ê²½ ëŒ€ì‘
            if (!res.ok || !res.previews) {
              console.error("âŒ ë¯¸ë¦¬ë³´ê¸° ì‹¤íŒ¨:", res.message);
              cutsContainer.innerHTML = `<p style='color:#f66'>âš ï¸ ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (${res.message || 'ì„œë²„ ì˜¤ë¥˜'})</p>`;
              return;
            }

            if (Object.keys(res.previews).length === 0) {
              cutsContainer.innerHTML = "<p style='color:#999'>âœ… ê°€ì´ë“œë¥¼ ì„¤ì •í•œ ì”¬ì´ ì—†ìŠµë‹ˆë‹¤. ì´ì „ìœ¼ë¡œ ëŒì•„ê°€ ì”¬ì„ ì„ íƒí•˜ì„¸ìš”.</p>";
              return;
            }

            // ğŸ–¼ï¸ 3ì—´ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ ìƒì„±
            const grid = document.createElement("div");
            grid.style.display = "grid";
            grid.style.gridTemplateColumns = "repeat(3, 1fr)";
            grid.style.gap = "20px";
            grid.style.maxWidth = "1300px";
            grid.style.margin = "0 auto";

            // âœ… keyë¥¼ ìˆ«ì ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ (1,2,3,...)
            Object.entries(res.previews)
              .sort((a, b) => {
                const numA = parseInt(a[0].split("_")[0]);
                const numB = parseInt(b[0].split("_")[0]);
                return numA - numB;
              })
              .forEach(([key, img]) => {
                const block = document.createElement("div");
                block.style.textAlign = "center";
                block.style.background = "#1a1a1a";
                block.style.padding = "10px";
                block.style.borderRadius = "8px";
                block.style.boxShadow = "0 0 6px rgba(0,0,0,0.5)";
                block.innerHTML = `
    <div style="color:#f7d794;font-size:16px;margin-bottom:8px;">${key}</div>
    <img src="${img}" style="width:100%;border:1px solid #444;border-radius:6px;">
  `;
                grid.appendChild(block);
              });

            // âœ… ì‹¤ì œë¡œ í™”ë©´ì— ì¶”ê°€
            cutsContainer.innerHTML = "";
            cutsContainer.appendChild(grid);
          })
          .catch(err => {
            console.error("âŒ ë¯¸ë¦¬ë³´ê¸° ìƒì„± ì¤‘ ì˜¤ë¥˜:", err);
            cutsContainer.innerHTML = "<p style='color:#f66'>ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ ë°œìƒ</p>";
          });

        return;
      }

      const scene = scenes[currentIndex];
      sceneTitle.innerText = `ì”¬ ${scene.scene_number}`;
      narrationText.innerText = scene.narration || "ë‚˜ë ˆì´ì…˜ ì—†ìŒ";
      let html = `<div class="scene-section">`;
      html += `<div class="cut-block">
        <div class="cut-title">ğŸ¬ PRIMARY CUT (${scene.primary_cut})</div>
        ${renderMergedImage(scene.primary_cut, "primary", scene.scene_number)}
      </div>`;
      if (scene.alternative_cuts && scene.alternative_cuts.length > 0) {
        scene.alternative_cuts.forEach((alt, i) => {
          html += `<div class="cut-block">
            <div class="cut-title">ğŸï¸ ALTERNATIVE CUT ${i + 1} (${alt})</div>
            ${renderMergedImage(alt, `alt${i + 1}`, scene.scene_number)}
          </div>`;
        });
      }
      html += `</div>`;
      cutsContainer.innerHTML = html;
      setupGuideCanvas();
      updateZoom();
    }

    // ğŸ”¹ ë²„íŠ¼
    document.getElementById("nextBtn").onclick = () => { currentIndex++; renderScene(); };
    document.getElementById("prevBtn").onclick = () => { if (currentIndex > 0) currentIndex--; renderScene(); };
    saveBtn.onclick = () => {

      if (saveBtn.disabled) return; // ğŸ‘ˆ [ì¶”ê°€] ë¹„í™œì„±í™” ì‹œ í´ë¦­ ë°©ì§€

      // ğŸ‘ˆ [ìˆ˜ì •] fetch payloadì— job_id ì¶”ê°€
      const payload = {
        job_id: JOB_ID,
        guides: guides
      };

      // ğŸ‘ˆ [ì¶”ê°€] ì €ì¥ ì¤‘ ë²„íŠ¼ ë¹„í™œì„±í™”
      saveBtn.disabled = true;
      saveBtn.innerText = "ì €ì¥ ì¤‘...";

      fetch("/save_crops", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload) // ğŸ‘ˆ [ìˆ˜ì •]
      })
        .then(r => r.json())
        .then(res => {
          if (res.ok) {
            alert("âœ… ì €ì¥ ì™„ë£Œ: " + res.message);
          } else {
            alert("âŒ ì €ì¥ ì‹¤íŒ¨: " + (res.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
          }
        })
        .catch(err => alert("âŒ ì €ì¥ ì‹¤íŒ¨: " + err))
        .finally(() => {
          // ğŸ‘ˆ [ì¶”ê°€] ì €ì¥ ì™„ë£Œ/ì‹¤íŒ¨ í›„ ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
          saveBtn.disabled = Object.keys(guides).length === 0; // ê°€ì´ë“œê°€ 0ê°œë©´ ë¹„í™œì„±í™”
          saveBtn.innerText = "ì €ì¥í•˜ê¸°";
        });
    };

    // â–¼ [ì¶”ê°€] í‚¤ë³´ë“œ ì¢Œìš° ë°©í–¥í‚¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.addEventListener("keydown", (e) => {
      // í…ìŠ¤íŠ¸ ì…ë ¥ ì˜ì—­ ë“±ì—ì„œëŠ” ì‘ë™í•˜ì§€ ì•Šë„ë¡ ë°©ì§€
      if (document.activeElement.tagName === "INPUT" || document.activeElement.tagName === "TEXTAREA" || document.activeElement.isContentEditable) {
        return;
      }

      if (e.key === "ArrowLeft") {
        document.getElementById("prevBtn").click();
      } else if (e.key === "ArrowRight") {
        document.getElementById("nextBtn").click();
      }
    });

    renderScene();
  </script>
</body>

</html>